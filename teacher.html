<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { 
  getDatabase, 
  ref, 
  onValue, 
  set, 
  get,
  remove
} from "https://www.gstatic.com/firebasejs/10.12.0/firebase-database.js";

const firebaseConfig = {
  apiKey: "AIzaSyBsrZ_k2K8u0ybvkEDoEywD_QWzmDTKjyY",
  authDomain: "black-cat-room.firebaseapp.com",
  databaseURL: "https://black-cat-room-default-rtdb.europe-west1.firebasedatabase.app",
  projectId: "black-cat-room",
  storageBucket: "black-cat-room.firebasestorage.app",
  messagingSenderId: "80028312826",
  appId: "1:80028312826:web:ee918db88c71a0c1335543"
};

const app = initializeApp(firebaseConfig);
const db = getDatabase(app);

let currentRoom = "";

/* ================================
   üöÄ SEND TASK
================================ */

window.sendTask = function () {
  const roomCode = document.getElementById("roomCode").value;
  const taskText = document.getElementById("taskInput").value;

  if (!roomCode || !taskText) 
    return alert("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –∏ –∑–∞–¥–∞–Ω–∏–µ");

  currentRoom = roomCode;

  set(ref(db, "rooms/" + roomCode + "/task"), taskText);

  loadAnswers(roomCode);
  loadLeaderboard(roomCode);

  alert("Task sent to room " + roomCode);
};

/* ================================
   üîÑ AUTO LOAD ANSWERS
================================ */

function loadAnswers(roomCode) {
  const answersRef = ref(db, "rooms/" + roomCode + "/answers");

  onValue(answersRef, (snapshot) => {
    const answers = snapshot.val();
    const container = document.getElementById("answersContainer");
    container.innerHTML = "";

    if (!answers) return;

    for (let name in answers) {
      const div = document.createElement("div");
      div.className = "answer-card";

      div.innerHTML = `
        <b>${name}</b>: ${answers[name]}
        <br><br>
        <button onclick="giveScore('${name}', 0.5)">0.5</button>
        <button onclick="giveScore('${name}', 1)">1</button>
        <button onclick="giveScore('${name}', 1.5)">1.5</button>
        <button onclick="giveScore('${name}', 2)">2</button>
        <button onclick="giveScore('${name}', 2.5)">2.5</button>
        <button onclick="giveScore('${name}', 3)">3</button>
      `;

      container.appendChild(div);
    }
  });
}

/* ================================
   üèÜ LEADERBOARD
================================ */

function loadLeaderboard(roomCode) {
  const scoresRef = ref(db, "rooms/" + roomCode + "/scores");

  onValue(scoresRef, (snapshot) => {
    const scores = snapshot.val();
    const board = document.getElementById("leaderboardContainer");
    board.innerHTML = "";

    if (!scores) return;

    const sorted = Object.entries(scores)
      .sort((a,b) => b[1] - a[1]);

    sorted.forEach(([name, points], index) => {
      const medal =
        index === 0 ? "ü•á" :
        index === 1 ? "ü•à" :
        index === 2 ? "ü•â" : "üêæ";

      board.innerHTML += `
        ${medal} ${name} ‚Äî ${points} pts<br>
      `;
    });
  });
}

/* ================================
   üéÆ GIVE SCORE
================================ */

window.giveScore = async function(studentName, value) {
  if (!currentRoom) return alert("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã");

  const scoreRef = ref(db, "rooms/" + currentRoom + "/scores/" + studentName);

  const snapshot = await get(scoreRef);
  let currentScore = snapshot.exists() ? snapshot.val() : 0;

  await set(scoreRef, parseFloat(currentScore) + parseFloat(value));
};

/* ================================
   üßπ CLEAR ANSWERS
================================ */

window.clearAnswers = function () {
  if (!currentRoom) return alert("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã");
  remove(ref(db, "rooms/" + currentRoom + "/answers"));
};

/* ================================
   üö™ CLOSE ROOM
================================ */

window.closeRoom = function () {
  if (!currentRoom) return alert("–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π –∫–æ–º–Ω–∞—Ç—ã");

  remove(ref(db, "rooms/" + currentRoom));
  document.getElementById("answersContainer").innerHTML = "";
  document.getElementById("leaderboardContainer").innerHTML = "";
};

</script>
