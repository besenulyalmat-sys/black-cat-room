<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Black Cat Room</title>
  <style>
    body { font-family: Arial; background: #111; color: white; padding: 20px; }
    button { padding: 8px 15px; margin: 5px; cursor: pointer; }
    textarea { width: 100%; height: 200px; background: #222; color: white; border: 1px solid #444; padding: 10px; }
    input { padding: 8px; margin: 5px 0; width: 300px; }
    .hidden { display: none; }
    .student { border: 1px solid #444; padding: 10px; margin: 10px 0; background:#1a1a1a; }
    h1 { color: #00ffcc; }
  </style>
</head>
<body>

<h1>üêà‚Äç‚¨õ Black Cat Room</h1>

<div id="login">
  <input id="nickname" placeholder="Your nickname"><br>
  <input id="roomCode" placeholder="Room code"><br>
  <button onclick="enterRoom()">Enter</button>
  <button onclick="enterTeacher()">Teacher Login</button>
</div>

<div id="studentView" class="hidden">
  <h3 id="taskText"></h3>
  <textarea id="codeArea" placeholder="Write your code here..."></textarea><br>
  <button onclick="submitWork()">üì© Submit</button>
  <h4>Teacher comment:</h4>
  <p id="comment"></p>
</div>

<div id="teacherView" class="hidden">
  <h3>Teacher Panel</h3>
  <input id="taskInput" placeholder="Write task here">
  <button onclick="updateTask()">Update Task</button>
  <button onclick="clearRoom()">Clear Room</button>
  <hr>
  <div id="students"></div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
import { getFirestore, doc, setDoc, onSnapshot, collection, deleteDoc, getDocs } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyBsrZ_k2K8u0ybvkEDoEywD_QWzmDTKjyY",
  authDomain: "black-cat-room.firebaseapp.com",
  projectId: "black-cat-room",
  storageBucket: "black-cat-room.firebasestorage.app",
  messagingSenderId: "80028312826",
  appId: "1:80028312826:web:ee918db88c71a0c1335543",
  measurementId: "G-9W8RSBP8WQ"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let currentRoom = "";
let currentUser = "";

window.enterRoom = function() {
  currentRoom = document.getElementById("roomCode").value;
  currentUser = document.getElementById("nickname").value;

  if (!currentRoom || !currentUser) {
    alert("Enter nickname and room code");
    return;
  }

  document.getElementById("login").classList.add("hidden");
  document.getElementById("studentView").classList.remove("hidden");

  onSnapshot(doc(db, "rooms", currentRoom), (docSnap) => {
    if (docSnap.exists()) {
      document.getElementById("taskText").innerText = docSnap.data().task || "";
    }
  });

  onSnapshot(collection(db, "rooms", currentRoom, "students"), (snapshot) => {
    snapshot.forEach(d => {
      if (d.id === currentUser) {
        document.getElementById("comment").innerText = d.data().comment || "";
      }
    });
  });
}

window.submitWork = async function() {
  await setDoc(doc(db, "rooms", currentRoom, "students", currentUser), {
    code: document.getElementById("codeArea").value,
    comment: "",
    status: "Submitted"
  });
  alert("Submitted!");
}

window.enterTeacher = function() {
  const pass = prompt("Enter teacher password:");
  if (pass !== "blackcat123") {
    alert("Wrong password");
    return;
  }

  currentRoom = prompt("Enter room code:");
  if (!currentRoom) return;

  document.getElementById("login").classList.add("hidden");
  document.getElementById("teacherView").classList.remove("hidden");

  onSnapshot(collection(db, "rooms", currentRoom, "students"), (snapshot) => {
    let html = "";
    snapshot.forEach(d => {
      const data = d.data();
      html += `
      <div class="student">
        <strong>${d.id}</strong><br>
        Status: ${data.status || "Writing"}<br>
        <pre>${data.code || ""}</pre>
        <textarea placeholder="Write comment..."
          onchange="updateComment('${d.id}', this.value)">${data.comment || ""}</textarea>
      </div>`;
    });
    document.getElementById("students").innerHTML = html;
  });
}

window.updateComment = async function(studentId, comment) {
  await setDoc(doc(db, "rooms", currentRoom, "students", studentId), {
    comment: comment
  }, { merge: true });
}

window.updateTask = async function() {
  await setDoc(doc(db, "rooms", currentRoom), {
    task: document.getElementById("taskInput").value
  }, { merge: true });
}

window.clearRoom = async function() {
  const querySnapshot = await getDocs(collection(db, "rooms", currentRoom, "students"));
  querySnapshot.forEach(async (docItem) => {
    await deleteDoc(doc(db, "rooms", currentRoom, "students", docItem.id));
  });
  alert("Room cleared!");
}
</script>

</body>
</html>

